#### 限界上下文
![image](https://static001.geekbang.org/resource/image/69/ee/69f44e120de5019c0fbff4d3fbc0afee.png)
- 通用语言定义上下文含义，限界上下文则定义领域边界
- 能够简单、清晰、准确描述业务涵义和规则的语言就是通用语言
    - 名词可以给领域对象命名
    - 动词则表示一个动作或事件
- 限界上下文
    - 限界就是领域的边界，而上下文则是语义环境
    - 用来封装通用语言和领域对象，提供上下文环境，保证在领域之内的一些术语、业务相关对象等（通用语言）有一个确切的含义
    - 领域边界就是通过限界上下文来定义的


#### 实体和值对象
- 实体和值对象是组成领域模型的基础单元
- 实体 
    - 拥有唯一标识符，且标识符在历经各种状态变更后仍能保持一致
    - 重要的不是其属性，而是其延续性和标识
    - 充血模型
        - 与这个实体相关的所有业务逻辑都在实体类的方法中实现
        - 跨多个实体的领域逻辑则在领域服务中实现
    - DDD 是先构建领域模型，针对实际业务场景构建实体对象和行为，再将实体对象映射到数据持久化对象
- 值对象
    - 通过对象属性值来识别的对象，它将多个相关属性组合为一个概念整体
    - 值对象描述了领域中的一件东西，是不可变的
    - 领域建模的过程中，值对象可以保证属性归类的清晰和概念的完整性，避免属性零碎
    - 值对象的运行形态
        - 引用单一属性的值对象或只有一条记录的多属性值对象的实体，可以采用属性嵌入的方式嵌入
        - 引用一条或多条记录的多属性值对象的实体，可以采用序列化大对象的方式嵌入
    - 优先做领域建模，弱化数据库的作用，只把数据库作为一个保存数据的仓库即可
    - 即使违反数据库设计原则，也不用大惊小怪，只要业务能够顺利运行，就没什么关系
    - 大对象方式： 无法满足基于值对象的快速查询，会导致搜索值对象属性值变得异常困难

#### 聚合和聚合根
- 实体和值对象就好比个体
- 能让实体和值对象协同工作的组织就是聚合
- 聚合根的特点：
    - 聚合根是实体，有实体的特点，具有全局唯一标识，有独立的生命周期
- 如果需要访问其它聚合的实体，就要先访问聚合根，再导航到聚合内部实体
- 聚合的一些设计原则
    - 在一致性边界内建模真正的不变条件
    - 设计小聚合
    - 通过唯一标识引用其它聚合
    - 在边界之外使用最终一致性
        - 在一次事务中，最多只能更改一个聚合的状态
        - 一次业务操作涉及多个聚合状态的更改，应采用领域事件的方式异步修改相关的聚合
    - 通过应用层实现跨聚合的服务调用

#### 领域事件：解耦微服务的关键
- 领域事件 用来表示领域中发生的事件。一个领域事件将导致进一步的业务操作
- 如果发生某种事件后，会触发进一步的操作，那么这个事件很可能就是领域事件
- 微服务内的领域事件
    - 发布方聚合将事件发布到事件总线，订阅方接收事件数据完成后续业务操作
    - 通过跨聚合的服务编排和组合，以服务调用的方式完成跨聚合的访问
- 微服务之间的领域事件
    - 主要目的是实现微服务解耦，减轻微服务之间实时服务访问的压力
    - 要总体考虑事件构建、发布和订阅、事件数据持久化、消息中间件，甚至事件数据持久化时还可能需要考虑引入分布式事务机制等
- 领域事件总体技术架构图
![image](https://static001.geekbang.org/resource/image/b2/8f/b221ed4011c23720ebe9f48ba8eee38f.jpg)
- 领域事件处理包括：
    - 事件构建和发布
        - 事件基本属性至少包括：事件唯一标识、发生时间、事件类型和事件源
        - 事件唯一标识应该是全局唯一
        - 事件基本属性主要记录事件自身以及事件发生背景的数据
        - 业务属性，用于记录事件发生那一刻的业务数据
        - 事件发布之前需要先构建事件实体并持久化
    - 事件数据持久化
        - 事件数据持久化可用于系统之间的数据对账
        - 或者实现发布方和订阅方事件数据的审计
        - 方法1：持久化到本地业务数据库的事件表中
            - 利用本地事务保证业务和事件数据的一致性
        - 方法2：持久化到共享的事件数据库中
            - 需要分布式事务机制来保证业务和事件数据的强一致性
            - 对系统性能造成一定的影响
    - 事件总线
        - 事件总线提供事件分发和接收等服务
        - 进程内模型，在微服务内聚合之间遍历订阅者列表，采取同步或异步的模式传递数据
    - 消息中间件
    - 事件接收和处理
![image](https://static001.geekbang.org/resource/image/89/11/89321072afd996c6a90fa9774f769e11.jpg)


#### DDD分层架构
- 核心理念都是为了设计出“高内聚低耦合”的架构
- DDD 分层架构
- ![image](https://static001.geekbang.org/resource/image/a3/01/a308123994f87a5ce99adc85dd9b4d01.jpg)
    - 用户接口层  向用户显示信息和解释用户指令
    - 应用层 理论上不应该有业务规则或逻辑，主要面向用例和流程相关的操作
        - 协调多个聚合的服务和领域对象完成服务编排和组合，协作完成业务操作
        - 应用服务是在应用层的，它负责服务的组合、编排和转发，负责处理业务用例的执行顺序以及结果的拼装，以粗粒度的服务通过API网关向前端发布
        - 进行安全认证、权限校验、事务控制、发送或订阅领域事件
    - 领域层
        - 实现企业核心业务逻辑
        - 体现领域模型的业务能力，它用来表达业务概念、业务状态和业务规则
        - 领域中的某些功能，单一实体（或者值对象）不能实现时，领域服务就会出马
    - 基础层
        - 为其它各层提供通用的技术和基础服务
        - 包括第三方工具、驱动、消息中间件、网关、文件、缓存以及数据库
        - 提供数据库持久化
    - DDD 分层架构有一个重要的原则：每层只能与位于其下方的层发生耦合
    - 严格分层架构  任何层只能对位于其直接下方的层产生依赖

#### 微服务架构模型
- 整洁架构
- ![image](https://static001.geekbang.org/resource/image/fc/42/fc8208d9f4cfadb7949d6e98a8c18442.png)
    - 最主要的原则是依赖原则
    - 越往里依赖越低，代码级别越高，越是核心能力
    - 外圆代码依赖只能指向内圆，内圆不需要知道外圆的任何情况
    - 各层的职能是这样划分
        - 领域模型实现领域内核心业务逻辑，它封装了企业级的业务规则
        - 领域服务实现涉及多个实体的复杂业务逻辑
        - 应用服务实现与用户操作相关的服务组合与编排
        - 最外层主要提供适配的能力，适配能力分为主动适配和被动适配
            - 主动适配主要实现外部用户、网页、批处理和自动化测试等对内层业务逻辑访问适配。
            - 被动适配主要是实现核心业务逻辑对基础资源访问的适配
        - 领域模型、领域服务和应用服务一起组成软件核心业务能力
- 六边形架构（端口适配器架构）
    - 核心理念是：应用是通过端口与外部进行交互的
    - 核心业务逻辑（应用程序和领域模型）与外部资源（包括 APP、Web 应用以及数据库资源等）完全隔离，仅通过适配器进行交互
    - 将系统分为内六边形和外六边形两层
        - 内的六边形实现应用的核心业务逻辑；
        - 六边形架构的一个端口可能对应多个外部系统
- ![image](https://static001.geekbang.org/resource/image/b2/71/b2e4dad1040857b5aedf0b1675ae4171.png)
- 中台和微服务设计
    - 关键：领域模型和微服务的合理分层设计
    - 中台本质上是领域的子域，可能是核心域，也可能是通用域或支撑域
    - 中台建设要聚焦领域模型，站在全企业的高度考虑能力的共享和复用
    - 微服务要有合理的架构分层： 引入防腐层，进行新老系统的适配和转换
        - 项目级微服务
            - 项目级微服务之间的集成，发生在微服务的应用层
        - ![image](https://static001.geekbang.org/resource/image/b4/9e/b4231550cfbd56c15ccb3795d1062f9e.png)
        - 企业级中台微服务
            - 在中台微服务之上增加一层，主要职能就是处理跨中台微服务的服务组合和编排
            - BFF微服务与其它微服务存在较大的差异，就是它没有领域模型
                - BFF： 服务于前端的后端，Backend for Frontends
            - ![image](https://static001.geekbang.org/resource/image/ee/3b/eeb66579c1725817d0e9185161f1843b.png)
    - 应用和资源的解耦与适配


####  中台
- 三个关键能力
    - 对前台业务的快速响应能力
    - 企业级复用能力
    - 从前台、中台到后台的设计、研发、页面操作、流程服务和数据的无缝联通、融合能力  
- 数据中台
    - 主要目标是打通数据孤岛，实现业务融合和创新，包括三大主要职能
    - 三大职能
        - 完成企业全域数据的采集与存储，实现各不同业务类别中台数据的汇总和集中管理
        - 按照标准的数据规范或数据模型，将数据按照不同主题域或场景进行加工和处理，形成面向不同主题和场景的数据应用
        - 建立业务需求驱动的数据体系，基于各个维度的数据，深度萃取数据价值，支持业务和商业模式的创新
    - 建设步骤
        - 第一步实现各中台业务数据的汇集，解决数据孤岛和初级数据共享问题。
        - 第二步实现企业级实时或非实时全维度数据的深度融合、加工和共享。
        - 第三步萃取数据价值，支持业务创新，加速从数据转换为业务价值的过程。


#### DDD、中台和微服务：它们是如何协作的
- DDD战略设计
- DDD战术设计方法
- 中台业务建模的过程
    - 按照业务流程或者功能属性、集合，将业务域细分为多个中台，再根据功能属性或重要性归类到核心中台或通用中台
    - 根据用例、业务场景或用户旅程完成事件风暴，找出实体、聚合和限界上下文，建立领域模型
    - 以主领域模型为基础，扫描其它中台领域模型，检查并确定是否存在重复或者需要重组的领域对象、功能，提炼并重构主领域模型，完成最终的领域模型设计
    - 选择其它主领域模型重复第三步，直到所有主领域模型完成比对和重构
    - 基于领域模型完成微服务设计，完成系统落地


#### 如何用DDD重构中台业务模型
- 构建中台业务模型策略
    - 自顶向下的策略
        - 先做顶层设计，从最高领域逐级分解为中台，分别建立领域模型
        - 领域建模过程主要基于业务现状，暂时不考虑系统现状
        - 自顶向下的策略适用于全新的应用系统建设，或旧系统推倒重建的情况
        - ![image](https://static001.geekbang.org/resource/image/e6/da/e665d85381a9b2c599555cac6a06deda.jpg)
    - 自底向上的策略
        - 基于业务和系统现状完成领域建模
        - 分别完成系统所在业务域的领域建模
        - 然后对齐业务域，重组领域对象，重构领域模型
        - 自底向上策略适用于遗留系统业务模型的演进式重构
        - 主要分为这样三个步骤
            - 锁定系统所在业务域，构建领域模型
            - 对齐业务域，构建中台业务模型
                - 找准基准域，划定上下文，聚合重归类
            - 中台归类，根据领域模型设计微服务

#### 如何用事件风暴构建领域模型
- 准备工作
    - 参与者： 项目团队和领域专家
        - 领域专家就是对业务或问题域有深刻见解的主题专家
        - 项目团队： DDD专家、架构师、产品经理、项目经理、开发人员和测试人员等
    - 要准备的材料
        - 即时贴: 用不同颜色的贴纸区分领域行为
            - 用蓝色表示命令，用绿色表示实体，橙色表示领域事件，黄色表示补充信息
        - 水笔
        - 白板、胶带或磁扣
    - 场地
        - 一堵足够长的墙和足够大的空间
        - 撤掉会议桌和椅子的事件风暴效率更高
    - 分析的关注点
        - 某些业务动作或行为（事件）是否会触发下一个业务动作
        - 动作（事件）的输入和输出是什么
        - 是谁发出的什么动作
- 领域建模的过程
    - 产品愿景： 使产品目标用户、核心价值、差异化竞争点等信息达成一致
    - 业务场景分析
        - 从用户视角出发的
        - 根据业务流程或用户旅程，采用用例和场景分析，探索领域中的典型场景
        - 找出领域事件、实体和命令等领域对象，支撑领域建模
    - 领域建模
        - 从命令和事件中提取产生这些行为的实体
        - 根据聚合根的管理性质找出聚合根
        - 划定限界上下文
    - 微服务拆分与设计
        - 考虑微服务落地时的技术、团队以及运行环境等非业务因素


#### 设计微服务代码模型
- DDD 分层架构模型
    - ![image](https://static001.geekbang.org/resource/image/a3/01/a308123994f87a5ce99adc85dd9b4d01.jpg)
    - ![image](https://static001.geekbang.org/resource/image/91/b8/915ad8d830d925a893cd09ff6cbdadb8.jpg)
    - 聚合之间的代码边界一定要清晰
    - 要有代码分层的概念

- 保证领域模型与代码模型的一致性
    - 使用事件风暴找出领域对象: 聚合、实体、命令和领域事件
    - 将领域对象分类： 领域模型、聚合、领域对象和领域类型
    - 通过用户故事或领域故事分析，及微服务设计，用于系统开发
        - 设计结果
            - 聚合、聚合根、实体、值对象、领域事件、领域服务和仓储等领域对象
        - 领域层的领域对象
            - 设计实体
            - 找出聚合根
                - 聚合外部实体仅记录id
                - 引用聚合内的所有实体
            - 设计值对象
            - 设计领域事件
            - 设计领域服务
                - 领域服务会对多个实体和实体方法进行组合和编排
            - 设计仓储： 每一个聚合都有一个仓储
        - 应用层的领域对象
            - 应用服务会对多个领域服务进行组合和编排，暴露给用户接口层
    - 领域对象与微服务代码对象的映射
        - 典型的领域模型
        - 非典型领域模型

#### 微服务边界
- 微服务的设计要涉及到逻辑边界、物理边界和代码边界等
- 演进式架构
    - 演进式架构就是以支持增量的、非破坏的变更作为第一原则，同时支持在应用程序结构层面的多维度变化
    - 微服务设计的重点，就是看微服务设计是否能够支持架构长期、轻松的演进
- 逻辑边界
    - 主要定义同一业务领域或应用内紧密关联的对象所组成的不同聚类的组合之间的边界
    - 微服务内聚合之间的边界就是逻辑边界
    - 按照 DDD 方法设计的微服务逻辑边界清晰，业务高内聚，聚合之间代码松耦合
- 物理边界
    - 主要从部署和运行的视角来定义微服务之间的边界
- 代码边界
    - 主要用于微服务内的不同职能代码之间的隔离


#### 服务和数据在微服务各层的协作
- 服务的调用
    - ![image](https://static001.geekbang.org/resource/image/e5/db/e5d025a6fd69d1f2cf2a1af53253abdb.png)
- 封装与组合 
    - ![image](https://static001.geekbang.org/resource/image/2d/1d/2d6a328a9fd8b4b3906bb9f59435ca1d.png)
    - 聚合之间的服务调用和数据交互应通过应用服务来完成
    - 禁止聚合之间的领域服务直接调用
    - 禁止聚合之间的数据表关联
- 数据对象视图
    - ![image](https://static001.geekbang.org/resource/image/95/73/95524b08051fcd181e65f825005a4c73.png)

#### 微服务后，前端如何设计
- 微前端
    - 按照领域模型和微服务边界，将前端页面进行拆分
    - 独立部署、完全自治、松耦合的页面组合
- 分类
    - 单一业务单元     一个微前端和一个微服务组成单一业务单元
    - 组合业务单元     多个微服务的前端功能，完成较复杂的页面和操作
    - 通用共享业务单元 通用共享微前端以共享页面的方式与其它微前端页面协作，完成业务流程
- 微前端的集成方式
    - ![image](https://static001.geekbang.org/resource/image/8d/f0/8d5fa14336fbf9a2cd239736e24c59f0.jpg)
    - 微前端与前端主页面的集成
    - 微前端与微服务的集成
- 团队职责边界
    - 负责企业内页面风格的整体风格设计、业务流程的流转和控制
    - 负责微前端页面动态加载、微前端注册、页面路由和页面数据共享等前端技术


#### 微服务设计和拆分的原则
- 演进策略
    - 绞杀者策略  逐步剥离业务能力，用微服务逐步替代原有单体系统的策略
    - 修缮者策略  维持原有系统整体能力不变，逐步优化系统整体能力的策略
- 复杂领域分三步来完成领域建模和微服务设计
    - 拆分子域建立领域模型
    - 领域模型微调
    - 微服务的设计和拆分
- 微服务设计原则
    - 要领域驱动设计，而不是数据驱动设计，也不是界面驱动设计
    - 要边界清晰的微服务，而不是泥球小单体
        - 微服务内聚合之间的领域服务和数据库实体原则上应杜绝相互依赖
        - 通过应用服务编排或者事件驱动，实现聚合之间的解耦，以便微服务的架构演进
    - 要职能清晰的分层，而不是什么都放的大箩筐
    - 要做自己能 hold 住的微服务，而不是过度拆分的微服务
- 微服务拆分主要考虑因素
    - 基于领域模型
    - 基于业务需求变化频率
    - 基于应用性能
    - 基于组织架构和团队规模
    - 基于安全边界
    - 基于技术异构等因素

#### 分布式架构关键设计
- 选择什么样的分布式数据库
    - 一体化分布式数据库方案
        - 支持数据多副本、高可用
        - 多采用 Paxos 协议，一次写入多数据副本，多数副本写入成功即算成功
        - 代表产品是 OceanBase 和高斯数据库
    - 集中式数据库 + 数据库中间件方案
        - 通过数据库中间件实现数据路由和全局数据管理
        - 采用数据库自身的同步机制实现主副本数据的一致性
        - MyCat+MySQL 方案
    - 集中式数据库 + 分库类库方案
        - 一种轻量级的数据库中间件方案
        - 分库类库实际上是一个基础 JAR 包，实现数据路由和数据归集
        - 典型分库基础组件有 ShardingSphere
- 如何设计数据库分库主键
    - 与客户接触的关键业务，建议你以客户 ID 作为分库主键
- 数据库的数据同步和复制
    - 一般采用基于数据库逻辑日志增量数据捕获（CDC）技术
    - CDC也可以用在领域事件驱动设计中，作为领域事件增量数据的获取技术
- 跨库关联查询如何处理
    - 跨多个业务线微服务查询
        - 建立面向主题的分布式数据库，它的数据来源于不同业务的微服务
        - 采用数据库日志捕获技术，从各业务端微服务将数据准实时汇集到主题数据库
    - 表与表之间的关联查询
        - 采用小表广播，在业务库中增加一张冗余的代码副表
- 如何处理高频热点数据
    - 将这些高频热点数据，从数据库加载到如 Redis 等缓存中
    - 需要模糊查询的高频数据，可以选用 ElasticSearch 等搜索引擎
- 前后序业务数据的处理
    - 通过领域事件处理机制，按需将前序数据通过领域事件实体，传输并冗余到后序微服务数据库
- 分三步来建设数据中台
    - 按照统一数据标准，完成不同微服务和渠道业务数据的汇集和存储 -- 解决数据孤岛和初级数据共享的问题
    - 建立主题数据模型，按照不同主题和场景对数据进行加工处理，建立面向不同主题的数据视图
    - 建立业务需求驱动的数据体系，支持业务和商业模式创新
- BFF 与企业级业务编排和协同
    - 增加一层 BFF 微服务（Backend for Frontends），用来处理微服务之间的服务组合和编排
- 分布式事务还是事件驱动机制
    - 实时性要求高的强一致性业务场景，可以采用分布式事务，尽量避免分布式事务的产生
    - 领域事件驱动的异步方式是分布式架构常用的设计方法，它可以解决非实时场景的数据最终一致性问题